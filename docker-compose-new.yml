
volumes:
  db-data-postgres:
  es-data:
  pgadmin-data:

networks:
  mdm_net:
    driver: bridge

services:
  # ===========================================
  # ZOOKEEPER (pour Kafka)
  # ===========================================
  zookeeper:
    container_name: mdm_zookeeper
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - mdm_net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # KAFKA (Ingestion & ETL)
  # ===========================================
  kafka:
    container_name: mdm_kafka
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_EXTERNAL://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_EXTERNAL://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
    networks:
      - mdm_net
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  # ===========================================
  # KAFKA UI (Interface Web)
  # ===========================================
  kafka-ui:
    container_name: mdm_kafka_ui
    image: provectuslabs/kafka-ui:latest
    depends_on:
      - kafka
    ports:
      - "9000:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: mdm_cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - mdm_net

  # ===========================================
  # POSTGRESQL (Base de données MDM)
  # ===========================================
  postgresql:
    container_name: mdm_postgresql
    image: docker.getcollate.io/openmetadata/postgresql:1.10.6
    restart: always
    command: "--work_mem=10MB"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: openmetadata_db
    ports:
      - "5432:5432"
    volumes:
      - db-data-postgres:/var/lib/postgresql/data
    networks:
      - mdm_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d openmetadata_db"]
      interval: 15s
      timeout: 10s
      retries: 10

  # ===========================================
  # ELASTICSEARCH (pour OpenMetadata)
  # ===========================================
  elasticsearch:
    container_name: mdm_elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.4
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - mdm_net
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\\|yellow\"'"]
      interval: 15s
      timeout: 10s
      retries: 10

  # ===========================================
  # OPENMETADATA - MIGRATION
  # ===========================================
  execute-migrate-all:
    container_name: mdm_migrate
    image: docker.getcollate.io/openmetadata/server:1.10.6
    command: "./bootstrap/openmetadata-ops.sh migrate"
    environment:
      OPENMETADATA_CLUSTER_NAME: mdm_cluster
      SERVER_PORT: 8585
      SERVER_ADMIN_PORT: 8586
      LOG_LEVEL: INFO
      
      # PostgreSQL Configuration
      DB_DRIVER_CLASS: org.postgresql.Driver
      DB_SCHEME: postgresql
      DB_USER: postgres
      DB_USER_PASSWORD: password
      DB_HOST: postgresql
      DB_PORT: 5432
      OM_DATABASE: openmetadata_db
      
      # Elasticsearch Configuration
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_SCHEME: http
      SEARCH_TYPE: elasticsearch
      
      # Authentication (Basic)
      AUTHORIZER_CLASS_NAME: org.openmetadata.service.security.DefaultAuthorizer
      AUTHORIZER_REQUEST_FILTER: org.openmetadata.service.security.JwtFilter
      AUTHORIZER_ADMIN_PRINCIPALS: "[admin]"
      AUTHENTICATION_PROVIDER: basic
      AUTHENTICATION_PUBLIC_KEYS: "[http://localhost:8585/api/v1/system/config/jwks]"
      AUTHENTICATION_ENABLE_SELF_SIGNUP: "true"
      
      # JWT Configuration
      RSA_PUBLIC_KEY_FILE_PATH: "./conf/public_key.der"
      RSA_PRIVATE_KEY_FILE_PATH: "./conf/private_key.der"
      JWT_ISSUER: open-metadata.org
      JWT_KEY_ID: Gb389a-9f76-gdjs-a92j-0242bk94356
      
      # Pipeline Service (désactivé car on utilise Kafka)
      PIPELINE_SERVICE_CLIENT_ENABLED: "false"
      
    depends_on:
      elasticsearch:
        condition: service_healthy
      postgresql:
        condition: service_healthy
    networks:
      - mdm_net

  # ===========================================
  # OPENMETADATA SERVER
  # ===========================================
  openmetadata-server:
    container_name: mdm_openmetadata
    image: docker.getcollate.io/openmetadata/server:1.10.6
    restart: always
    environment:
      OPENMETADATA_CLUSTER_NAME: mdm_cluster
      SERVER_PORT: 8585
      SERVER_ADMIN_PORT: 8586
      LOG_LEVEL: INFO
      
      # PostgreSQL Configuration
      DB_DRIVER_CLASS: org.postgresql.Driver
      DB_SCHEME: postgresql
      DB_USER: postgres
      DB_USER_PASSWORD: password
      DB_HOST: postgresql
      DB_PORT: 5432
      OM_DATABASE: openmetadata_db
      
      # Elasticsearch Configuration
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_SCHEME: http
      SEARCH_TYPE: elasticsearch
      
      # Authentication
      AUTHORIZER_CLASS_NAME: org.openmetadata.service.security.DefaultAuthorizer
      AUTHORIZER_REQUEST_FILTER: org.openmetadata.service.security.JwtFilter
      AUTHORIZER_ADMIN_PRINCIPALS: "[admin]"
      AUTHENTICATION_PROVIDER: basic
      AUTHENTICATION_PUBLIC_KEYS: "[http://localhost:8585/api/v1/system/config/jwks]"
      AUTHENTICATION_ENABLE_SELF_SIGNUP: "true"
      
      # JWT Configuration
      RSA_PUBLIC_KEY_FILE_PATH: "./conf/public_key.der"
      RSA_PRIVATE_KEY_FILE_PATH: "./conf/private_key.der"
      JWT_ISSUER: open-metadata.org
      JWT_KEY_ID: Gb389a-9f76-gdjs-a92j-0242bk94356
      
      # Pipeline Service (désactivé)
      PIPELINE_SERVICE_CLIENT_ENABLED: "false"
      
      # Heap Options
      OPENMETADATA_HEAP_OPTS: -Xmx1G -Xms1G
      
    ports:
      - "8585:8585"
      - "8586:8586"
    depends_on:
      elasticsearch:
        condition: service_healthy
      postgresql:
        condition: service_healthy
      execute-migrate-all:
        condition: service_completed_successfully
    networks:
      - mdm_net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8586/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ===========================================
  # PGADMIN (Interface PostgreSQL)
  # ===========================================
  pgadmin:
    container_name: mdm_pgadmin
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "5050:80"
    depends_on:
      - postgresql
    networks:
      - mdm_net
    volumes:
      - ./pgadmin-data:/var/lib/pgadmin